var txnId = require('./txnId');
const fs = require("fs")

const ADMINS = []
const DB_URL = ''
const BOT_TOKEN = ""

const set_chat = "-"
const set_userbot = "-"
const set_payment = "-"
const set_admin = "-"
const set_money = "-"
const set_wallet = "-"

const set_op_1 = "-"
const set_op_2 = "-"
const set_op_3 = "-"
const set_op_4 = "-"
const set_op_5 = "-"
var SponsorArray = [];

oplata = 3000000

process.env.TZ = 'Moscow/Europe';


const mongo = require('mongoose');
mongo.connect(DB_URL);


var User = mongo.model('User', {
    id: Number,
    name: String,
    outbalance: Number,
    set_withdraw: Number,
    set_ref: Number,
    set_chat: String,
    set_userbot: String,
    set_payment: String,
    set_admin: String,
    set_money: String,
    set_wallet: String,
    set_op_1: String,
    set_op_2: String,
    set_op_3: String,
    set_op_4: String,
    set_op_5: String,
    set_money_message: String,
    fc: Number,
    ref: Number,
    regDate: String,
    fetuses: Number,
    menu: String,
    statusklik: String,
    ban: Boolean,
    refCount: Number,
    not: Boolean,
    data: String,
    spinsToday: Number,
    klik: Number,
    check: Boolean,
    payout: Number,
    checkrefstatus: Boolean,
    bonuscount: Number,
});

const Config = mongo.model("configs", { parameter: String, value: Number, description: String })

var Task = mongo.model('Task', {
    id: Number
});

const Ticket = mongo.model('Ticket', {
    id: Number,
    amount: Number,
    wallet: String
});

const Voucher = mongo.model("Voucher", { id: String, tree_id: Number })

function generateID(res) { var text = ""; var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; for (var i = 0; i < res; i++) text += possible.charAt(Math.floor(Math.random() * possible.length)); return text }

const Start = [
    ["üíú –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å", "üíº –ü—Ä–æ—Ñ–∏–ª—å"],
    ["üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"],
];

const Cancel = [
    ["‚óÄÔ∏è –ù–∞–∑–∞–¥"]
];

const TAPI_admin = {
    inline_keyboard: [
        [{ text: "üíú –†–∞—Å—Å—ã–ª–∫–∞", callback_data: "admin_mm" }, { text: "üìä –¢–æ–ø –∑–∞ 24 —á–∞—Å–∞", callback_data: "admin_top" }],
        [{ text: "üñá –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", callback_data: "admin_u" }, { text: "üí∏ –í—ã–ø–ª–∞—Ç—ã", callback_data: "admin_w" }],
        [{ text: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", callback_data: "setings" }],
    ]
};

const TAPI_admin_return = {
    inline_keyboard: [
        [{ text: "‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data: "admin_return" }],
    ]
};

const RM_mm1 = {
    inline_keyboard: [
        [{ text: "‚èπ –°—Ç–æ–ø", callback_data: "admin_mm_stop" }],
        [{ text: "‚è∏ –ü–∞—É–∑–∞", callback_data: "admin_mm_pause" }],
    ]
};

const RM_mm2 = {
    inline_keyboard: [
        [{ text: "‚èπ –°—Ç–æ–ø", callback_data: "admin_mm_stop" }],
        [{ text: "‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", callback_data: "admin_mm_play" }],
    ]
};

const Telegram = require('node-telegram-bot-api');
const bot = new Telegram(BOT_TOKEN, { polling: true });

bot.getMe().then(r => console.log(r));

bot.on('text', async(message) => {
            message.send = (text, params) => bot.sendMessage(message.chat.id, text, params);
            let $menu = [];
            var uid = message.from.id;
            var text = message.text;
            let dt = new Date
            console.log("[" + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds() + "] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + uid + " –æ—Ç–ø—Ä–∞–≤–∏–ª: " + text);

            if (dt.getDate() == oplata) return message.send('‚õî –í—ã –Ω–µ –æ–ø–ª–∞—Ç–∏–ª–∏ —Ö–æ—Å—Ç–∏–Ω–≥!\nüöÄ –ë–æ—Ç —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é @Seba_Setka!!');

            if (message.text) {
                if (message.text.startsWith('/start') || message.text == 'üîô –ù–∞–∑–∞–¥') {
                    let $user = await User.findOne({ id: message.from.id });
                    if (!$user) {
                        let schema = {
                            id: message.from.id,
                            name: message.from.first_name,
                            outbalance: 0,
                            set_withdraw: 0,
                            set_ref: 0,
                            ref: 0,
                            set_chat: "",
                            set_userbot: "",
                            set_admin: "",
                            set_payment: "",
                            set_money: "",
                            set_money_message: "",
                            set_wallet: "",
                            set_op_1: "",
                            set_op_2: "",
                            set_op_3: "",
                            set_op_4: "",
                            set_op_5: "",
                            ban: false,
                            not: false,
                            checkrefstatus: true,
                            check: true,
                            regDate: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`,
                            menu: "",
                            statusklik: "",
                            data: "",
                            refCount: 0,
                            fc: 0,
                            payout: 0,
                            spinsToday: 0,
                            klik: 0,
                            bonuscount: 0,
                        };

                        let reffer = Number(message.text.split('/start')[1]);

                        if (reffer) {
                            let $reffer = await User.findOne({ id: reffer })
                            if ($reffer) {
                                schema.ref = $reffer.id
                                await $reffer.inc('outbalance', 0)
                                await $reffer.inc('refCount', 0)
                                bot.sendMessage($reffer.id, `<b></b>`, { parse_mode: "HTML" });
                            }
                        }

                        let user = new User(schema);
                        await user.save();
                    }


                    return message.send(`üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!`, {
                        parse_mode: "HTML",
                        reply_markup: {
                            keyboard: Start,
                            resize_keyboard: true
                        }
                    });
                }
            }

            message.user = await User.findOne({ id: message.from.id });
            if (!message.user) return message.send(`üò± –ë–æ—Ç –±—ã–ª –æ–±–Ω–æ–≤–ª√´–Ω!\nüìù –ù–∞–ø–∏—à–∏—Ç–µ /start —á—Ç–æ–±—ã –±–æ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞–ª!`);
            if (message.user.ban) return
            if (!message.user.name || message.user.name != message.from.first_name)
                await User.findOneAndUpdate({ id: message.from.id }, { name: message.from.first_name })

            if (state[uid] == 99 && ADMINS.indexOf(message.from.id) !== -1 && text != "0") {
                state[uid] = undefined
                bot.sendMessage(uid, "üöÄ –†–∞—Å—Å—ã–ª–∫–∞ –≤ –≤–∞—à–µ–º –±–æ—Ç–µ –∑–∞–ø—É—â–µ–Ω–∞!").then((e) => {
                    if (text.split("#").length == 4) {
                        var btn_text = text.split("#")[1].split("#")[0].replace(/(^\s*)|(\s*)$/g, '')
                        var btn_link = text.split("#")[2].split("#")[0].replace(/(^\s*)|(\s*)$/g, '')
                        text = text.split("#")[0]
                        mm_t(text, e.message_id, e.chat.id, true, btn_text, btn_link, 100)
                    } else mm_t(text, e.message_id, e.chat.id, false, false, false, 100)
                })
            }

            var set_op_1 = (await User.findOne({ id: 0 })).set_op_1
            var set_op_2 = (await User.findOne({ id: 0 })).set_op_2
            var set_op_3 = (await User.findOne({ id: 0 })).set_op_3
            var set_op_4 = (await User.findOne({ id: 0 })).set_op_4
            var set_op_5 = (await User.findOne({ id: 0 })).set_op_5
            var buttonsArray = [
                [{ text: "üè™ –ú–∞–≥–∞–∑–∏–Ω –±–æ—Ç–æ–≤", url: "" }],
            ];
            if (set_op_1 && set_op_1.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_1}` }]);
            }
            if (set_op_2 && set_op_2.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_2}` }]);
            }
            if (set_op_3 && set_op_3.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_3}` }]);
            }
            if (set_op_4 && set_op_4.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_4}` }]);
            }
            if (set_op_5 && set_op_5.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_5}` }]);
            }
            if (true) {
                buttonsArray.push([{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å", callback_data: "checkch" }]);
            }
            if (message.user.check) {
                return bot.sendMessage(message.chat.id, `üîí <b>–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã!</b>`, {
                    parse_mode: "html",
                    reply_markup: {
                        inline_keyboard: buttonsArray
                    }
                });
            }
            var set_op_1 = (await User.findOne({ id: 0 })).set_op_1
            var set_op_2 = (await User.findOne({ id: 0 })).set_op_2
            var set_op_3 = (await User.findOne({ id: 0 })).set_op_3
            var set_op_4 = (await User.findOne({ id: 0 })).set_op_4
            var set_op_5 = (await User.findOne({ id: 0 })).set_op_5
            var buttonsArray = [
                [{ text: "üè™ –ú–∞–≥–∞–∑–∏–Ω –±–æ—Ç–æ–≤", url: "" }],
            ];
            if (set_op_1 && set_op_1.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_1}` }]);
            }
            if (set_op_2 && set_op_2.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_2}` }]);
            }
            if (set_op_3 && set_op_3.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_3}` }]);
            }
            if (set_op_4 && set_op_4.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_4}` }]);
            }
            if (set_op_5 && set_op_5.trim() !== "") {
                buttonsArray.push([{ text: "üí≥ –°–ø–æ–Ω—Å–æ—Ä", url: `https://t.me/${set_op_5}` }]);
            }
            if (true) {
                buttonsArray.push([{ text: "üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å", callback_data: "checkch" }]);
                var modifiedSponsorArray = SponsorArray.filter(item => item !== null && item !== "");
                console.log("", modifiedSponsorArray.map(item => "@" + item))
            }
            if ((await bot.getChatMember("", uid)).status == "left") { //—Å—é–¥–∞ —Å–æ–±–∞—á–∫—É
                return message.send(`üîí <b>–í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã!</b>`, {
                    parse_mode: "html",
                    reply_markup: {
                        inline_keyboard: buttonsArray
                    }
                });
            }

            if (state[uid] == 100 && ADMINS.indexOf(message.from.id) !== -1 && text != "0") {
                var set_money = (await User.findOne({ id: 0 })).set_money
                state[uid] = undefined

                message.text = Number(message.text);
                let user = await User.findOne({ id: message.text });
                let u = user
                if (!user) return message.send('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç—É –≤ –≤–∞—à–µ–º –±–æ—Ç–µ!');

                let partners = await User.find({ ref: message.text });
                await message.user.set('menu', '');
                var kb = { inline_keyboard: [] }
                if (u.ban) kb.inline_keyboard.push([{ text: "Ô∏è‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data: "unban_" + u.id }])
                else kb.inline_keyboard.push([{ text: "‚ùå –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data: "ban_" + u.id }])
                kb.inline_keyboard.push([{ text: "‚ûï –ë–∞–ª–∞–Ω—Å –≤—ã–≤–æ–¥–∞", callback_data: "addOutBal_" + u.id }])
                kb.inline_keyboard.push([{ text: "‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data: "admin_return" }])
                return message.send(`üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤: <b>${partners.length}</b>
üÜî ID: <code>${user.id}</code>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üíé –ë–∞–ª–∞–Ω—Å –≤—ã–≤–æ–¥–∞: ${user.outbalance.toFixed(2)}${set_money}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí≥ <b>–í—ã–≤–µ–ª: ${roundPlus(user.payout)}${set_money}</b>
`, {
                    parse_mode: "HTML",
                    reply_markup: kb
                });

            }

            if (state[uid] == 701 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ $unset: { set_op_1: "" } })
                return message.send(`‚úÖ –í—ã —É–¥–∞–ª–∏–ª–∏ –∫–∞–Ω–∞–ª #1 !`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 702 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ $unset: { set_op_2: "" } })
                return message.send(`‚úÖ –í—ã —É–¥–∞–ª–∏–ª–∏ –∫–∞–Ω–∞–ª #2 !`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 703 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ $unset: { set_op_3: "" } })
                return message.send(`‚úÖ –í—ã —É–¥–∞–ª–∏–ª–∏ –∫–∞–Ω–∞–ª #3 !`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 704 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ $unset: { set_op_4: "" } })
                return message.send(`‚úÖ –í—ã —É–¥–∞–ª–∏–ª–∏ –∫–∞–Ω–∞–ª #4 !`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 705 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ $unset: { set_op_5: "" } })
                return message.send(`‚úÖ –í—ã —É–¥–∞–ª–∏–ª–∏ –∫–∞–Ω–∞–ª #5 !`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 102 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ set_op_1: text })
                await bot.sendMessage(uid, `‚úÖ –í—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ @${text} –Ω–∞ –∫–∞–Ω–∞–ª #1 !`, { reply_markup: TAPI_admin_return });
                SponsorArray.push('@' + { text })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 103 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ set_op_2: text })
                await bot.sendMessage(uid, `‚úÖ –í—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ @${text} –Ω–∞ –∫–∞–Ω–∞–ª #2 !`, { reply_markup: TAPI_admin_return });
                SponsorArray.push('@' + { text })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 104 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ set_op_3: text })
                await bot.sendMessage(uid, `‚úÖ –í—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ @${text} –Ω–∞ –∫–∞–Ω–∞–ª #3 !`, { reply_markup: TAPI_admin_return });
                SponsorArray.push({ set_op_3: text })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 105 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ set_op_4: text })
                await bot.sendMessage(uid, `‚úÖ –í—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ @${text} –Ω–∞ –∫–∞–Ω–∞–ª #4 !`, { reply_markup: TAPI_admin_return });
                SponsorArray.push('@' + { text })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 1055 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined;
                await User.findOneAndUpdate({ set_op_5: text })
                await bot.sendMessage(uid, `‚úÖ –í—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ @${text} –Ω–∞ –∫–∞–Ω–∞–ª #5 !`, { reply_markup: TAPI_admin_return });
                SponsorArray.push('@' + { text })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 106 && ADMINS.indexOf(message.from.id) !== -1) {
                var set_money = (await User.findOne({ id: 0 })).set_money
                state[uid] = undefined
                await User.findOneAndUpdate({ id: data[uid] }, { $inc: { outbalance: Number(text) } })
                bot.sendMessage(data[uid], `‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ <b>${text}${set_money}</b>!`, { parse_mode: html })
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 107 && ADMINS.indexOf(message.from.id) !== -1) {
                var set_money = (await User.findOne({ id: 0 })).set_money
                state[uid] = undefined
                text = Number(text.replace("%", ""))
                await User.findOneAndUpdate({ id: 0 }, { set_ref: text })
                return message.send(`‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞ ${text}${set_money} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 108 && ADMINS.indexOf(message.from.id) !== -1) {
                var set_money = (await User.findOne({ id: 0 })).set_money
                state[uid] = undefined
                text = Number(text.replace("%", ""))
                await User.findOneAndUpdate({ id: 0 }, { set_withdraw: text })
                return message.send(`‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ ${text}${set_money} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 109 && ADMINS.indexOf(message.from.id) !== -1) {
                var set_money = (await User.findOne({ id: 0 })).set_money
                state[uid] = undefined
                text = Number(text.replace("%", ""))
                await User.findOneAndUpdate({ id: 0 }, { outbalance: text })
                return message.send(`‚úÖ –ë–æ–Ω—É—Å –≤ ${text}${set_money} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 110 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_chat: text })
                return message.send(`‚úÖ Username —á–∞—Ç–∞ @${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 111 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_userbot: text })
                return message.send(`‚úÖ Username –±–æ—Ç–∞ @${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 112 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_payment: text })
                return message.send(`‚úÖ Username –≤—ã–ø–ª–∞—Ç @${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 113 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_admin: text })
                return message.send(`‚úÖ Username –∞–¥–º–∏–Ω–∞ @${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 114 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_money: text })
                return message.send(`‚úÖ –í–∞–ª—é—Ç–∞ ${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 115 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_wallet: text })
                return message.send(`‚úÖ –ö–æ—à–µ–ª√´–∫ ${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (state[uid] == 116 && ADMINS.indexOf(message.from.id) !== -1) {
                state[uid] = undefined
                await User.findOneAndUpdate({ set_money_message: text })
                return message.send(`‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –≤—ã–ø–ª–∞—Ç –≤ ${text} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!`, { reply_markup: TAPI_admin_return });
                setTimeout(() => { process.exit(0) }, 333);
            }
            if (message.text) {
                if (message.text == '‚óÄÔ∏è –ù–∞–∑–∞–¥') {
                    state[uid] = undefined
                    await message.user.set('menu', '');
                    return message.send('üîí –í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –º–µ–Ω—é! ', {
                        reply_markup: {
                            keyboard: $menu,
                            resize_keyboard: true
                        }
                    });
                }
            }

            if (message.user.menu.startsWith('amountQiwi')) {
                var set_withdraw = (await User.findOne({ id: 0 })).set_withdraw
                var set_money = (await User.findOne({ id: 0 })).set_money
                message.text = Number(message.text);

                if (!message.text) return message.send('üí≥ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏:');
                if (message.text <= 0) return message.send('üí≥ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏:');

                if (message.text > message.user.outbalance) return message.send('‚ö†Ô∏è –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –æ–±–æ–π—Ç–∏ —Å–∏—Å—Ç–µ–º—É!');
                if (message.text < set_withdraw) return message.send('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!');


                if (message.text <= message.user.outbalance) {
                    await message.user.dec('outbalance', message.text);
                    let ticket = new Ticket({
                        id: message.from.id,
                        amount: message.text,
                        wallet: message.user.menu.split('amountQiwi')[1]
                    });

                    await ticket.save();
                    await message.user.set('menu', '');

                    ADMINS.map((x) => bot.sendMessage(x, "üî• –£ –≤–∞—Å –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–ø–ª–∞—Ç—É!"));

                    bot.sendMessage("@", `üë• <b> <a href="tg://user?id=${message.chat.id}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a> –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥!
üóíÔ∏è –î–∞—Ç–∞: ${getTimeString()}
üí≥ –°—É–º–º—É –≤—ã–≤–æ–¥–∞: ${ticket.amount}${set_money}
üíé –ü–ª–∞—Ç—ë–∂–Ω–∞—è –°–∏—Å—Ç–µ–º–∞: ${ticket.wallet.indexOf("P") == -1 ? "QIWI" : "PAYEER"}</b>`, { parse_mode: "HTML" })

                    return message.send(`üöÄ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≥–æ—Ç–æ–≤–∞ –æ–∂–∏–¥–∞–π—Ç–µ! `, {
                        parse_mode: "HTML",
                        reply_markup: {
                            keyboard: $menu,
                            resize_keyboard: true
                        }
                    });
                }
            }

            if (message.user.menu == 'qiwi') {
                var set_money = (await User.findOne({ id: 0 })).set_money

                if (message.text.length < 0) return message.send('üßê –ü–æ—Ö–æ–¥—É –≤—ã –Ω–∞–ø–∏—Å–∞–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä!', {
                    reply_markup: {
                        keyboard: Cancel,
                        resize_keyboard: true
                    }
                });



                await message.user.set('menu', 'amountQiwi' + message.text);
                return message.send(`üíé –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤—ã–≤–æ–¥–∞.\n –í–∞—à –±–∞–ª–∞–Ω—Å: ${message.user.outbalance.toFixed(2)}${set_money}`);
            }


            if (message.text == 'üíú –ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å') {
                var set_ref = (await User.findOne({ id: 0 })).set_ref
                var set_money = (await User.findOne({ id: 0 })).set_money
                var set_userbot = (await User.findOne({ id: 0 })).set_userbot
                var set_admin = (await User.findOne({ id: 0 })).set_admin
                var set_chat = (await User.findOne({ id: 0 })).set_chat
                var set_payment = (await User.findOne({ id: 0 })).set_payment
                var s = await User.findOne({ id: 0 })
                let t = new Date()
                t = t.getTime() - 1593648000 * 1000
                var day = t / 86400000 ^ 0
                let stats = {
                    users: await User.countDocuments(),
                    users_today: await User.find({ regDate: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}` }),
                    cmds: message.message_id
                }

                stats.users_today = stats.users_today.length;

                return message.send(`üí∏<b> –ú—ã –ø–ª–∞—Ç–∏–º –∑–∞ –¥—Ä—É–∑–µ–π –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—à–ª–∏ –ø–æ –≤–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏!
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë• –ó–∞ –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∞: ${set_ref}${set_money}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üîé –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</b>
<code>https://t.me/?start=${message.from.id}</code>`, {
                    parse_mode: "HTML",
                    reply_markup: {
                        keyboard: $menu,
                        resize_keyboard: true
                    }
                });
            }


            if (message.text == 'üíº –ü—Ä–æ—Ñ–∏–ª—å') {
                var set_admin = (await User.findOne({ id: 0 })).set_admin
                var set_chat = (await User.findOne({ id: 0 })).set_chat
                var set_payment = (await User.findOne({ id: 0 })).set_payment
                var set_money = (await User.findOne({ id: 0 })).set_money
                var set_payment = (await User.findOne({ id: 0 })).set_payment
                var set_money = (await User.findOne({ id: 0 })).set_money
                var s = await User.findOne({ id: 0 })
                let t = new Date()
                t = t.getTime() - 1593648000 * 1000
                var day = t / 86400000 ^ 0
                let stats = {
                    users: await User.countDocuments(),
                    users_today: await User.find({ regDate: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}` }),
                    cmds: message.message_id
                }

                stats.users_today = stats.users_today.length;

                return message.send(`üÜî <b>ID:</b> <code>${message.from.id}</code>
	‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
	üíé <b>–ë–∞–ª–∞–Ω—Å:</b> ${message.user.outbalance.toFixed(2)}${set_money}
	‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
	üë• –£ –≤–∞—Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: ${await User.countDocuments({ ref: message.from.id })}
	üë§ –í–∞—Å –ø—Ä–∏–≤–µ–ª: ${message.user.ref != 0 ? `<a href="tg://user?id=${message.user.ref}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a>` : "<i>–°–æ–∑–¥–∞—Ç–µ–ª—å</i>"}`,{
				parse_mode: "HTML",
				reply_markup: {
					inline_keyboard: [
						[{ text: "üì• –í—ã–≤–µ—Å—Ç–∏", callback_data: "withdraw" }],
					]
				}
			});
		}

		if (message.text == 'üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è') {
			var set_admin = (await User.findOne({ id: 0 })).set_admin
			var set_chat = (await User.findOne({ id: 0 })).set_chat
			var set_payment = (await User.findOne({ id: 0 })).set_payment
			var set_money = (await User.findOne({ id: 0 })).set_money
			var s = await User.findOne({ id: 0 })
			let t = new Date()
            t = t.getTime() - 1593648000 * 1000
			var day = t / 86400000 ^ 0
			let stats = {
				users: await User.countDocuments(),
				users_today: await User.find({ regDate: `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}` }),
				cmds: message.message_id
			}

			stats.users_today = stats.users_today.length;

		return message.send(`üìó<b> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤—Å–µ–≥–æ: <b>${stats.users}</b>
üí≥ –í—ã–ø–ª–∞—á–µ–Ω–æ –≤—Å–µ–≥–æ: <b>${Math.round (s.fc)}${set_money}</b>`,{
				parse_mode: "HTML",
				reply_markup: {
					inline_keyboard: [
					    [{ text: "üî• –•–æ—á—É —Ç–∞–∫–æ–π –∂–µ –±–æ—Ç", url: "" }],
                        [{ text: "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", url: `` }],
                        [{ text: "üí¨ –ß–∞—Ç", url: `` }, { text: "üí≥ –í—ã–ø–ª–∞—Ç—ã", url: `https://t.me/Seba_vivodi` }],
					]
				}
			});
	}

if (ADMINS.indexOf(message.from.id) !== -1) {
		if (message.text == '/a') {
			var h = process.uptime() / 3600 ^ 0
			var m = (process.uptime() - h * 3600) / 60 ^ 0
			var s = process.uptime() - h * 3600 - m * 60 ^ 0
			var heap = process.memoryUsage().rss / 1048576 ^ 0

         			bot.sendMessage(uid, '<b>üñ•Ô∏è –¶–µ–Ω—Ç—Ä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b>\n\n<b>–ù–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–∞:</b> ' + h + ' —á–∞—Å–æ–≤ ' + m + ' –º–∏–Ω—É—Ç ' + s + ' —Å–µ–∫—É–Ω–¥\n<b>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ: </b>' + (await User.countDocuments({})) + '\n<b>üíæ –ù–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏:</b> ' + heap + "–ú–ë\n<b>üí≥ –ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥:</b> " + await Ticket.countDocuments(), { parse_mode: "HTML", reply_markup: TAPI_admin })
		}

		if (message.text.startsWith('/1setbuybalance')) {
			let cmd = message.text.split(' ');
			if (!cmd[1]) return message.send('–û—à–∏–±–∫–∞!');

			let user = await User.findOne({ id: Number(cmd[1]) });
			if (!user) return message.send('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â—ë –Ω–µ—Ç—É –≤ –≤–∞—à–µ–º –±–æ—Ç–µ!');

			await user.set('buybalance', Number(cmd[2]));
			return message.send('–ë–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
		}

		if (message.text.startsWith('/restart')) {
		  var id = message.user.id
		  ADMINS.map((a) => bot.sendMessage(a, `üîÑ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω !`, { parse_mode: "HTML" }))
			setTimeout(() => { process.exit(0) }, 333);
		}

		if (message.text.startsWith('/setoutbalance')) {
			let cmd = message.text.split(' ');
			if (!cmd[1]) return message.send('–û—à–∏–±–∫–∞!');

			let user = await User.findOne({ id: Number(cmd[1]) });
			if (!user) return message.send('‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â—ë –Ω–µ—Ç—É –≤ –≤–∞—à–µ–º –±–æ—Ç–µ!');

			await user.set('outbalance', Number(cmd[2]));
			return message.send('–ë–∞–ª–∞–Ω—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
		}
	}
});

bot.on('callback_query', async (query) => {
	const { message } = query;
	message.user = await User.findOne({ id: message.chat.id });
	var uid = message.chat.id
	let dt = new Date
	console.log("[" + dt.getHours() + ":" + dt.getMinutes() + ":" + dt.getSeconds() + "] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + uid + " –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–æ–ª–±—ç–∫: " + query.data)

	if (dt.getDate() == oplata) return message.send('‚õî –í—ã –Ω–µ –æ–ø–ª–∞—Ç–∏–ª–∏ —Ö–æ—Å—Ç–∏–Ω–≥!\nüöÄ –ë–æ—Ç —Å–æ–∑–¥–∞–Ω —Å –ø–æ–º–æ—â—å—é @Seba_Setka');

	if (!message.user) return bot.answerCallbackQuery(query.id, '‚ö†Ô∏è –û—à–∏–±–∫–∞!', true);

	if (query.data == 'none') return bot.answerCallbackQuery(query.id, '‚ö†Ô∏è –û—à–∏–±–∫–∞!', true);

	if (query.data.startsWith('checkch')) {
	 var set_ref = (await User.findOne({ id: 0 })).set_ref
	 let u = await User.findOne({id: message.chat.id})
	 var modifiedSponsorArray = SponsorArray.filter(item => item !== null && item !== "");
	 var res = await bot.getChatMember("", message.chat.id);

	 if (res.status == 'left') return bot.answerCallbackQuery(query.id, '‚õî –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ –Ω–∞—à–∏ –∫–∞–Ω–∞–ª—ã!', true);
	 await bot.deleteMessage(message.chat.id, message.message_id);
	 await User.findOneAndUpdate({ id: message.chat.id }, { check: false })

		if ( u.ref != 0 && u.checkrefstatus) {
		 await User.findOneAndUpdate({ id: u.ref }, { $inc: { refCount: 1} })
		 await User.findOneAndUpdate({ id: u.ref }, { $inc: { outbalance: set_ref} })
		 await User.findOneAndUpdate({ id: u.id }, { checkrefstatus: false })
		 bot.sendMessage(u.ref, `<b>üë§ –£ –≤–∞—Å –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª! </b>\nüí∏ –í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏: ${set_ref}${set_money} !`, { parse_mode: "HTML" }).catch((e) => {});
	 }
	 return bot.sendMessage(message.chat.id, 'üî• –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–ø–æ–Ω—Å–æ—Ä–æ–≤!', { parse_mode: "HTML" })
 }

	if (query.data == 'setings') {
		bot.deleteMessage(message.chat.id, message.message_id);
		return bot.sendMessage(message.chat.id, `üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ !`, {
			parse_mode: "HTML",
			reply_markup: {
			     inline_keyboard: [
			            [{ text: "üí∏ –ù–∞–≥—Ä–∞–¥–∞", callback_data: "set_admin" }, { text: "üí∞ –ú–∏–Ω.–≤—ã–≤–æ–¥", callback_data: "admin_wind" }],
                		[{ text: "üéÅ –ë–æ–Ω—É—Å –∑–∞ —Ä–µ–≥.", callback_data: "admin_bonus" }, { text: "üí≤ –í–∞–ª—é—Ç–∞", callback_data: "user_val" }],
                        [{ text: "üíú –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞", callback_data: "setings_op" }],
			          ]
			}

		});
	}

	if (query.data == 'setings_op') {
    var set_op_1 = (await User.findOne({ id: 0 })).set_op_1
    var set_op_2 = (await User.findOne({ id: 0 })).set_op_2
    var set_op_3 = (await User.findOne({ id: 0 })).set_op_3
    var set_op_4 = (await User.findOne({ id: 0 })).set_op_4
    var set_op_5 = (await User.findOne({ id: 0 })).set_op_5
		bot.deleteMessage(message.chat.id, message.message_id);
		return bot.sendMessage(message.chat.id, `üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –±–æ—Ç–∞!`, {
			parse_mode: "HTML",
			reply_markup: {
			     inline_keyboard: [
			            [{ text: "‚óΩÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å #1", callback_data: "set_op_1" }, { text: "‚óΩÔ∏è –£–¥–∞–ª–∏—Ç—å #1", callback_data: "del_op_1" }],
                  [{ text: "‚óΩÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å #2", callback_data: "set_op_2" }, { text: "‚óΩÔ∏è –£–¥–∞–ª–∏—Ç—å #2", callback_data: "del_op_2" }],
                  [{ text: "‚óΩÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å #3", callback_data: "set_op_3" }, { text: "‚óΩÔ∏è –£–¥–∞–ª–∏—Ç—å #3", callback_data: "del_op_3" }],
                  [{ text: "‚óΩÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å #4", callback_data: "set_op_4" }, { text: "‚óΩÔ∏è –£–¥–∞–ª–∏—Ç—å #4", callback_data: "del_op_4" }],
                  [{ text: "‚óΩÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å #5", callback_data: "set_op_5" }, { text: "‚óΩÔ∏è –£–¥–∞–ª–∏—Ç—å #5", callback_data: "del_op_5" }],
			          ]
			}

		});
	}

	if (query.data == 'withdraw') {
		var set_withdraw = (await User.findOne({ id: 0 })).set_withdraw
		var set_wallet = (await User.findOne({ id: 0 })).set_wallet
		var set_money = (await User.findOne({ id: 0 })).set_money
		if (message.user.outbalance < set_withdraw)
			return bot.answerCallbackQuery(query.id, `‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: ${set_withdraw}${set_money}\nüí≥ –í–∞—à –±–∞–ª–∞–Ω—Å: ${message.user.outbalance.toFixed(2)}${set_money}`, true);
		if (message.user.refCount < 0) return bot.answerCallbackQuery(query.id,'üö´ –î–ª—è –≤—ã–≤–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è 0 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤!', true);
		bot.deleteMessage(message.chat.id, message.message_id);
  await bot.sendMessage(message.chat.id, `üöÄ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞`, {
        parse_mode: "HTML",
				reply_markup: {
					inline_keyboard: [
					[{ text: `‚óΩÔ∏è –°–ë–ü`, callback_data: "wallet" }],
					[{ text: `‚óΩÔ∏è –ö–∞—Ä—Ç–∞ –†–§`, callback_data: "wallet_1" }],
          [{ text: `‚óΩÔ∏è Crypto Bot`, callback_data: "wallet_2" }],
					]
				}
			});
 }

	if(query.data == 'wallet') {
    await message.user.set('menu', 'qiwi');
		await bot.sendMessage(message.chat.id, 'üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:', {
			reply_markup: {
				keyboard: Cancel,
				resize_keyboard: true
			}
		});
	}

	if(query.data == 'wallet_1') {
    await message.user.set('menu', 'qiwi');
		await bot.sendMessage(message.chat.id, 'üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:', {
			reply_markup: {
				keyboard: Cancel,
				resize_keyboard: true
			}
		});
	}

  if(query.data == 'wallet_2') {
    await message.user.set('menu', 'qiwi');
		await bot.sendMessage(message.chat.id, 'üìù –í–≤–µ–¥–∏—Ç–µ UserName:', {
			reply_markup: {
				keyboard: Cancel,
				resize_keyboard: true
			}
		});
	}

	if (query.data.startsWith('withdraw:')) {
		var set_money_message = (await User.findOne({ id: 0 })).set_money_message
		var set_admin = (await User.findOne({ id: 0 })).set_admin
		var set_money = (await User.findOne({ id: 0 })).set_money
		let id = Number(query.data.split('withdraw:')[1]);
		let ticket = await Ticket.findOne({ id });

		if (!ticket) bot.deleteMessage(message.chat.id, message.message_id);
		if (ticket.wallet.indexOf("P") == -1) {
			bot.sendMessage(set_money_message, `<b><a href="tg://user?id=${ticket.id}">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</a> –≤—ã–ø–ª–∞—á–µ–Ω–æ: <b>${ticket.amount}</b>${set_money}</b>`, { parse_mode: "HTML" })
		}
		else
		{
			bot.sendMessage(set_money_message, `<b><a href="tg://user?id=${ticket.id}">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</a> –≤—ã–ø–ª–∞—á–µ–Ω–æ: <b>${ticket.amount}</b>${set_money}</b>`, { parse_mode: "HTML" })

		}
		bot.sendMessage(ticket.id,` ‚úÖ <b>–í–∞—à–∞ –≤—ã–ø–ª–∞—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìû –ö–æ—à–µ–ª—ë–∫: ${ticket.wallet}
üí≥ –°—É–º–º–∞: ${ticket.amount}${set_money}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
ü§ù <b>–†–∞–¥—ã —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å!</b>`, {
		  parse_mode: "html",
          reply_markup: {
			inline_keyboard: [
			  [{ text: "üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", url: `` }],
			]
		  }
		});

		await User.findOneAndUpdate({ id: 0 }, { $inc: { fc: ticket.amount } })
		await User.findOneAndUpdate({ id: id }, { $inc: { payout: ticket.amount } })
	await ticket.remove();
		bot.editMessageText('üí≤–í—ã–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—ã–ª –æ–¥–æ–±—Ä–µ–Ω!', {
		  chat_id: message.chat.id,
		  message_id: message.message_id
		});
	  }

	if (query.data.startsWith('back:')) {
		let id = Number(query.data.split('back:')[1]);
		let ticket = await Ticket.findOne({ id });

		if (!ticket) bot.deleteMessage(message.chat.id, message.message_id);

		let user = await User.findOne({ id: ticket.id });
		bot.sendMessage(ticket.id, `‚ö†Ô∏è –í–∞—à–∞ –≤—ã–ø–ª–∞—Ç–∞ –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!`);

		await user.inc('outbalance', ticket.amount);
		await ticket.remove();

		return bot.editMessageText('‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ!', {
			chat_id: message.chat.id,
			message_id: message.message_id
		});
	}

	var d = query.data

	if (ADMINS.indexOf(query.from.id) !== -1) {
		if (d == "admin_mm") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏!', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 99
		} else if (d == "admin_w") {
			var set_money = (await User.findOne({ id: 0 })).set_money
			bot.deleteMessage(message.chat.id, message.message_id);
			let tickets = await Ticket.find();
			if (tickets.length == 0) return bot.sendMessage(uid, '‚ò∫Ô∏è –ü–æ—Ö–æ–¥—É –≤—ã —É–º–Ω–∏—á–∫–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥ –Ω–µ—Ç—É!');
			await tickets.map((x) => {
				bot.sendMessage(uid, `üìù: <a href="tg://user?id=${x.id}">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a> (ID: <code>${x.id}</code>)\n
	üî• –°—É–º–º–∞: <code>${x.amount}</code>${set_money}
	üí≥ –ö–æ—à–µ–ª—ë–∫: <code>${x.wallet}</code>
	üïù –î–∞—Ç–∞: ${getTimeString()}`, {
					parse_mode: "HTML", reply_markup: { inline_keyboard: [[{ text: '‚úîÔ∏è –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', callback_data: `withdraw:${x.id}` }], [{ text: '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å', callback_data: `back:${x.id}` }]] }
				});
			});
		}

		else if (d == "admin_top") {
			bot.deleteMessage(message.chat.id, message.message_id);
			var u = await User.find({ ref: { $ne: 0 }, _id: { $gt: mongo.Types.ObjectId.createFromTime(Date.now() / 1000 - 24 * 60 * 60) } })
			console.log(u)
			var top = []
			u.map((e) => {
				var t = top.filter(u => { if (e.ref == u.id) return true; else return false })
				if (t.length == 0) top.push({ id: e.ref, ref: 1 })
				else {
					top = top.filter(u => { if (e.ref == u.id) return false; else return true })
					top.push({ id: e.ref, ref: t[0].ref + 1 })
				}
			})
			top = top.sort((a, b) => { if (a.ref <= b.ref) return 1; else return -1 })
			top.length = 20
			var str = `<b>üïí –¢–æ–ø —Ä–µ—Ñ–æ–≤–æ–¥–æ–≤:</b>\n\n`
			for (const i in top) {
				var us = await User.findOne({ id: top[i].id })
				str += `<b>${Number(i) + 1})</b> <a href="tg://user?id=${us.id}">${us.name ? us.name : "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}</a> - <b>${top[i].ref}</b> –¥—Ä—É–∑–µ–π\n`
			}
			bot.sendMessage(uid, str, { reply_markup: { inline_keyboard: [[{ text: "‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data: "admin_return" }]] }, parse_mode: "HTML" })
		}

		else if (d == "admin_u") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 100
		}
		else if (d == "del_op_1") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, 'üö´ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ !\n\n –ù–∞–ø–∏—à–µ—Ç–µ –±–æ—Ç—É "–£–¥–∞–ª—è—é" !', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 701
			SponsorArray.shift()
		}
		else if (d == "del_op_2") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, 'üö´ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ !\n\n –ù–∞–ø–∏—à–µ—Ç–µ –±–æ—Ç—É "–£–¥–∞–ª—è—é" !', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 702
			SponsorArray[2] = null

		}
		else if (d == "del_op_3") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, 'üö´ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ !\n\n –ù–∞–ø–∏—à–µ—Ç–µ –±–æ—Ç—É "–£–¥–∞–ª—è—é" !', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 703
			SponsorArray[3] = null
		}
		else if (d == "del_op_4") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, 'üö´ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ !\n\n –ù–∞–ø–∏—à–µ—Ç–µ –±–æ—Ç—É "–£–¥–∞–ª—è—é" !', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 704
			SponsorArray[4] = null
		}
		else if (d == "del_op_5") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, 'üö´ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ !\n\n –ù–∞–ø–∏—à–µ—Ç–µ –±–æ—Ç—É "–£–¥–∞–ª—è—é" !', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 705
			SponsorArray.pop
		}
		else if (d == "set_op_1") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username –∫–∞–Ω–∞–ª–∞', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 102
		}
		else if (d == "set_op_2") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '‚úÖ –í—ã –¥–æ–ª–∂–Ω—ã –≤–≤–µ—Å—Ç–∏ UserName', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 103
		}
		else if (d == "set_op_3") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '‚úÖ –í—ã –¥–æ–ª–∂–Ω—ã –≤–≤–µ—Å—Ç–∏ UserName', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 104
		}
		else if (d == "set_op_4") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '‚úÖ –í—ã –¥–æ–ª–∂–Ω—ã –≤–≤–µ—Å—Ç–∏ UserName', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 105
		}
    else if (d == "set_op_5") {
      bot.deleteMessage(message.chat.id, message.message_id);
      bot.sendMessage(uid, '‚úÖ –í—ã –¥–æ–ª–∂–Ω—ã –≤–≤–µ—Å—Ç–∏ UserName', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
      state[uid] = 1055
    }

		else if (d.split("_")[0] == "addOutBal") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 106
			data[uid] = d.split("_")[1]
		}
		else if (d == "set_admin") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–í–≤–µ–¥–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –æ–ø–ª–∞—Ç—É', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 107
		}
		else if (d == "admin_wind") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 108
		}
		else if (d == "admin_bonus") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–í–≤–µ–¥–∏—Ç–µ –±–æ–Ω—É—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –±–æ—Ç–µ', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 109
		}
		else if (d == "user_chat") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username —á–∞—Ç–∞ –±–µ–∑ @', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 110
		}
		else if (d == "user_bot") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username –±–æ—Ç–∞ –±–µ–∑ @', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 111
		}
		else if (d == "user_pay") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username –≤—ã–ø–ª–∞—Ç –±–µ–∑ @', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 112
		}
		else if (d == "user_admin") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username –∞–¥–º–∏–Ω–∞ –±–µ–∑ @', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 113
		}
		else if (d == "user_val") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞–ª—é—Ç—É –±–æ—Ç–∞', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 114
		}
		else if (d == "user_win") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ—à–µ–ª√´–∫ –∫—É–¥–∞ –±—É–¥–µ—Ç–µ –≤—ã–≤–æ–¥–∏—Ç—å', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 115
		}
		else if (d == "user_pay_of") {
			bot.deleteMessage(message.chat.id, message.message_id);
			bot.sendMessage(uid, '–ù–∞–ø–∏—à–∏—Ç–µ username –≤—ã–ø–ª–∞—Ç —Å @', { reply_markup: TAPI_admin_return, parse_mode: "HTML" })
			state[uid] = 116
		}

		else if (d == "admin_mm_stop") {
			var tek = Math.round((mm_i / mm_total) * 40)
			var str = ""
			for (var i = 0; i < tek; i++) str += "+"
			str += '>'
			for (var i = tek + 1; i < 41; i++) str += "-"
			mm_status = false;
			bot.editMessageText("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!", { chat_id: mm_achatid, message_id: mm_amsgid })
			mm_u = []
		}
		else if (d == "admin_mm_pause") {
			var tek = Math.round((mm_i / mm_total) * 40)
			var str = ""
			for (var i = 0; i < tek; i++) str += "+"
			str += '>'
			for (var i = tek + 1; i < 41; i++) str += "-"
			bot.editMessageText("<b>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</b> " + mm_i + '/' + mm_total + ' - ' + Math.round((mm_i / mm_total) * 100) + '%\n' + str + "\n\n<b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n<b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> " + mm_ok + "\n<b>–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö:</b> " + mm_err, { chat_id: mm_achatid, message_id: mm_amsgid, reply_markup: RM_mm2, parse_mode: html })
			mm_status = false;
		}
		else if (d == "admin_mm_play") {
			mm_status = true;
			bot.editMessageText("–í—ã–ø–æ–ª–Ω–µ–Ω–æ: " + mm_i + '/' + mm_total + ' - ' + Math.round((mm_i / mm_total) * 100) + '%\n', { chat_id: mm_achatid, message_id: mm_amsgid, reply_markup: RM_mm1 })
		}
		else if (d.split("_")[0] == "ban") {
			var uuid = Number(d.split("_")[1])
			await User.findOneAndUpdate({ id: uuid }, { ban: true })
			bot.editMessageText('<a href="tg://user?id=' + uuid + '">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a> –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!', { chat_id: uid, message_id: message.message_id, parse_mode: html })
		}
		else if (d.split("_")[0] == "unban") {
			var uuid = Number(d.split("_")[1])
			await User.findOneAndUpdate({ id: uuid }, { ban: false })
			bot.editMessageText('<a href="tg://user?id=' + uuid + '">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</a> —Ä–∞–∑–±–∞–Ω–µ–Ω!', { chat_id: uid, message_id: message.message_id, parse_mode: html })
    }
		else if (d == "admin_return") {
			bot.deleteMessage(message.chat.id, message.message_id);
			var h = process.uptime() / 3600 ^ 0
			var m = (process.uptime() - h * 3600) / 60 ^ 0
			var s = process.uptime() - h * 3600 - m * 60 ^ 0
			var heap = process.memoryUsage().rss / 1048576 ^ 0
			var b = (await User.findOne({ id: 0 })).deposit

         			bot.sendMessage(uid, '<b>üñ•Ô∏è –¶–µ–Ω—Ç—Ä –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏:</b>\n\n<b>–ù–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–∞:</b> ' + h + ' —á–∞—Å–æ–≤ ' + m + ' –º–∏–Ω—É—Ç ' + s + ' —Å–µ–∫—É–Ω–¥\n<b>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–æ—Ç–µ: </b>' + (await User.countDocuments({})) + '\n<b>üíæ –ù–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏:</b> ' + heap + "–ú–ë\n<b>üí≥ –ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥:</b> " + await Ticket.countDocuments(), { parse_mode: "HTML", reply_markup: TAPI_admin })
		}
	}
});

var state = []


User.prototype.inc = function (field, value = 1) {
	this[field] += value;
	return this.save();
}

User.prototype.dec = function (field, value = 1) {
	this[field] -= value;
	return this.save();
}

User.prototype.set = function (field, value) {
	this[field] = value;
	return this.save();
}

async function mmTick() {
	if (mm_status) {
		try {
			mm_i++
			if (mm_type == "text") {
				if (mm_btn_status)
					bot.sendMessage(mm_u[mm_i - 1], mm_text, { reply_markup: { inline_keyboard: [[{ text: mm_btn_text, url: mm_btn_link }]] }, parse_mode: html }).then((err) => { mm_ok++ }).catch((err) => { mm_err++ })
				else
					bot.sendMessage(mm_u[mm_i - 1], mm_text, { parse_mode: html }).then((err) => { console.log((mm_i - 1) + ') ID ' + mm_u[mm_i - 1] + " OK"); mm_ok++ }).catch((err) => { mm_err++ })
			}
			else if (mm_type == "img") {
				if (mm_btn_status)
					bot.sendPhoto(mm_u[mm_i - 1], mm_imgid, { caption: mm_text, reply_markup: { inline_keyboard: [[{ text: mm_btn_text, url: mm_btn_link }]] } }).then((err) => { mm_ok++ }).catch((err) => { mm_err++ })
				else
					bot.sendPhoto(mm_u[mm_i - 1], mm_imgid, { caption: mm_text }).then((err) => { console.log((mm_i - 1) + ') ID ' + mm_u[mm_i - 1] + " OK"); mm_ok++ }).catch((err) => { mm_err++ })
			}
			if (mm_i % 10 == 0) {
				var tek = Math.round((mm_i / mm_total) * 40)
				var str = ""
				for (var i = 0; i < tek; i++) str += "+"
				str += '>'
				for (var i = tek + 1; i < 41; i++) str += "-"
				bot.editMessageText("<b>–í—ã–ø–æ–ª–Ω–µ–Ω–æ:</b> " + mm_i + '/' + mm_total + ' - ' + Math.round((mm_i / mm_total) * 100) + '%\n' + str + "\n\n<b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n<b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> " + mm_ok + "\n<b>–ù–µ—É—Å–ø–µ—à–Ω—ã—Ö:</b> " + mm_err, { chat_id: mm_achatid, message_id: mm_amsgid, reply_markup: RM_mm1, parse_mode: html })
			}
			if (mm_i == mm_total) {
				mm_status = false;
				bot.editMessageText("–í—ã–ø–æ–ª–Ω–µ–Ω–æ: " + mm_i + '/' + mm_total, { chat_id: mm_achatid, message_id: mm_amsgid })
				sendAdmins('<b>–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n–£—Å–ø–µ—à–Ω–æ:</b> ' + mm_ok + "\n<b>–ù–µ—É—Å–ø–µ—à–Ω–æ:</b> " + mm_err, { parse_mode: html })
				mm_u = []
			}
		} finally { }
	}
}

setInterval(mmTick, 100);

var mm_total
var mm_i
var mm_status = false
var mm_amsgid
var mm_type
var mm_imgid
var mm_text
var mm_achatid
var mm_btn_status
var mm_btn_text
var mm_btn_link
var mm_ok
var mm_err

async function mm_t(text, amsgid, achatid, btn_status, btn_text, btn_link, size) {
	let ut = await User.find({}, { id: 1 }).sort({ _id: -1 })
	mm_total = ut.length
	console.log(ut)
	mm_u = []
	for (var i = 0; i < mm_total; i++)
		mm_u[i] = ut[i].id
	if (size != 100) {
		mm_u = randomizeArr(mm_u)
		mm_total = Math.ceil(mm_total * (size / 100))
		mm_u.length = mm_total
	}
	ut = undefined
	mm_i = 0;
	mm_amsgid = amsgid
	mm_type = "text"
	mm_text = text
	mm_ok = 0
	mm_err = 0
	mm_achatid = achatid
	if (btn_status) {
		mm_btn_status = true
		mm_btn_text = btn_text
		mm_btn_link = btn_link
	}
	else
		mm_btn_status = false
	mm_status = true;
}

bot.on('photo', async msg => {
	if (msg.from != undefined) {
		var uid = msg.from.id
		if (state[uid] == 99 && ADMINS.indexOf(uid) !== -1) {
			state[uid] = undefined
			var text = ""
			if (msg.caption != undefined) text = msg.caption
			bot.sendMessage(uid, "–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞!").then((e) => {
				if (text.split("#").length == 4) {
					var btn_text = text.split("#")[1].split("#")[0].replace(/(^\s*)|(\s*)$/g, '')
					var btn_link = text.split("#")[2].split("#")[0].replace(/(^\s*)|(\s*)$/g, '')
					text = text.split("#")[0].replace(/(^\s*)|(\s*)$/g, '').replace(' ', '')
					mm_img(msg.photo[msg.photo.length - 1].file_id, text, e.message_id, e.chat.id, true, btn_text, btn_link, 100)

				}
				else
					mm_img(msg.photo[msg.photo.length - 1].file_id, text, e.message_id, e.chat.id, false, false, false, 100)

			})
		}
	}
})



async function mm_img(img, text, amsgid, achatid, btn_status, btn_text, btn_link, size) {
	let ut = await User.find({}, { id: 1 }).sort({ _id: -1 })
	mm_total = ut.length
	mm_u = []
	for (var i = 0; i < mm_total; i++)
		mm_u[i] = ut[i].id
	if (size != 100) {
		mm_u = randomizeArr(mm_u)
		mm_total = Math.ceil(mm_total * (size / 100))
		mm_u.length = mm_total
	}

	ut = undefined
	mm_i = 0;
	mm_amsgid = amsgid
	mm_type = "img"
	mm_text = text
	mm_imgid = img
	mm_ok = 0
	mm_err = 0
	mm_achatid = achatid
	if (btn_status) {
		mm_btn_status = true
		mm_btn_text = btn_text
		mm_btn_link = btn_link
	}
	else
		mm_btn_status = false
	mm_status = true;
}

function randomizeArr(arr) {
	var j, temp;
	for (var i = arr.length - 1; i > 0; i--) {
		j = Math.floor(Math.random() * (i + 1));
		temp = arr[j];
		arr[j] = arr[i];
		arr[i] = temp;
	}
	return arr;
}

const html = "HTML"

function sendAdmins(text, params) { for (var i = 0; i < ADMINS.length; i++) bot.sendMessage(ADMINS[i], text, params) }

var data = []


function roundPlus(number) { if (isNaN(number)) return false; var m = Math.pow(10, 2); return Math.round(number * m) / m; }

async function main() {
	var u = (await User.find({}, { id: 1 })).map((e) => { return e.id })
	for (var i in u) {
		await User.findOneAndUpdate({ id: u[i] }, { refCount: await User.countDocuments({ ref: u[i] }) })
		console.log(i)
	}

}





function randomizeArr(arr) {
	var j, temp;
	for (var i = arr.length - 1; i > 0; i--) {
		j = Math.floor(Math.random() * (i + 1));
		temp = arr[j];
		arr[j] = arr[i];
		arr[i] = temp;
	}
	return arr;
}

function randomInteger(min, max) {

	let rand = min + Math.random() * (max + 1 - min);

	return Math.floor(rand);
}

async function ticker() {
	var d = new Date()
	var minutes = d.getMinutes()
	var hours = d.getHours()
	var date = d.getDate()
	if (minutes == 0 && hours == 0)
		await User.updateMany({}, { spinsToday: 0 })
}

setInterval(ticker, 1000 * 60)


function randomInteger(min, max) {

	let rand = min + Math.random() * (max + 1 - min);
	return Math.floor(rand);
}
User.insertMany([
{ "_id" : "5dfaac928d3ea75ef63263ba", "trees": [ ], "id" : 0, "buybalance" : 0, "outbalance": 0, "klik": 0, "bhivebalance" :0, "wb_profits" : 0, "name" : "TAPI SHOP", "fc" : 0, "ref" : 0, "regDate" : "18/12/2019", "deposit" : 0, "payout" : 0,  "fetuses" : 0, "menu" : "{\"price\":20,\"status\":false,\"count\":5,\"bought\":3}", "statusklik" :"{\"status\":false}", "lastCollect" : 1576709266975, "ban" : false, "refCount" : 0, "not" : false, "__v" : 0, "totalEarn" : 0, "prudLevel" : 0 },
{ "_id" : "5dfbe31493b06e7818e2c5d7", "trees" : [ ], "id" : 1, "menu" : "{\"price\":20,\"status\":true,\"count\":5,\"bought\":3}", "statusklik" :"{\"status\":true}", "__v" : 0, "totalEarn" : 0, "prudLevel" : 0 }
]).then()

User.updateMany({}, {statusklik: ""}).then()

function getTimeString() {
    var date = new Date()
    var day = String(date.getDate())
    if (day.length == 1) day = "0" + day
    var month = String(date.getMonth() + 1)
    if (month.length == 1) month = "0" + month
    var year = date.getFullYear()
    var hour = String(date.getHours() + 3)
    if (hour.length == 1) hour = "0" + hour
    var minute = String(date.getMinutes())
    if (minute.length == 1) minute = "0" + minute
    var second = String(date.getSeconds())
    if (second.length == 1) second = "0" + second
    return `${day}.${month}.${year}\n‚è≥ –í—Ä–µ–º—è ${hour}:${minute}:${second}`
}